name: Deploy to Swarm

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: self-hosted   # ğŸ‘ˆ ä½ æœ¬æ©Ÿ runner æœƒåŸ·è¡Œ
    env:
      DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USER }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}

    steps:
      # Step 1 â”€ checkout å°ˆæ¡ˆåŸå§‹ç¢¼
      - name: Checkout code
        uses: actions/checkout@v3

      # Step 2 â”€ Docker Login
      - name: Login to Docker Hub
        run: echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USER" --password-stdin

      # Step 3 â”€ Build & Push backend
      - name: Build backend
        run: |
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            -t testforccsa/final:backend \
            -f backend/Dockerfile backend \
            --push

      # Step 4 â”€ Build & Push frontend
      - name: Build frontend
        run: |
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            -t testforccsa/final:frontend \
            -f frontend/Dockerfile frontend \
            --push

      # Step 5 â”€ Build & Push generator
      - name: Build generator
        run: |
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            -t testforccsa/final:generator \
            -f generator/Dockerfile generator \
            --push

      # Step 6 â”€ Build & Push db
      - name: Build db
        run: |
          docker buildx build \
            --platform linux/amd64,linux/arm64 \
            -t testforccsa/final:db \
            -f db/Dockerfile db \
            --push

      # Step 7 â”€ é‡æ–°éƒ¨ç½² Swarm
      - name: Deploy to Swarm
        run: |
          colima start   # ç¢ºä¿ colima é–‹å•Ÿ
          docker info    # æª¢æŸ¥ Docker æ˜¯å¦é€£åˆ° VM
          docker stack deploy -c stack.yaml ccsa
